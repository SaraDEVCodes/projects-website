---
import MainLayout from "../../layouts/MainLayout.astro";
export const prerender = false;
import { getEntry } from "astro:content";
import { formatDate } from "../../utils";
import Tags from "../../components/Tags.astro";
import { marked } from "marked";

const { slug } = Astro.params;

if (!slug) throw new Error("Slug is required");

const entry = await getEntry("project", slug);

if (!entry) {
    return Astro.redirect("/404");
}

const { Content } = await entry.render();

const hasUpdates = entry.data.hasUpdates === true;

const url = new URL(Astro.request.url);
const activeTab = url.searchParams.get("tab") || "overview";

// Convert updates markdown string to HTML
const updatesHTML = hasUpdates ? marked.parse(entry.data.updates) : "";
---

<script>
    window.scrollGallery = function (direction) {
        const gallery = document.getElementById("gallery");
        if (!gallery) return;
        const width = gallery.offsetWidth;
        const isMobile = window.innerWidth <= 768;
        const scrollAmount = isMobile ? width * 1 : width * 0.6;
        gallery.scrollBy({
            left: direction * scrollAmount,
            behavior: "smooth",
        });
    };
</script>

<MainLayout>
    <div
        class="flex flex-col items-start px-4 sm:px-6 lg:px-20 max-w-screen-xl mx-auto"
    >
        <a
            href="/projects"
            class="bg-red-500 hover:bg-red-800 text-white font-semibold text-base uppercase tracking-wide py-2 px-4 mb-10 rounded-full shadow-md transition duration-200"
        >
            Back To All Projects
        </a>

        <article class="w-full">
            <h1 class="text-3xl sm:text-4xl font-bold mb-2">
                {entry.data.title}
            </h1>
            <h3 class="text-base sm:text-lg mb-2">
                {entry.data.author} Published {formatDate(entry.data.pubDate)}
            </h3>

            <Tags tags={entry.data.tags} />

            <img
                src={"/images/" + entry.data.image}
                alt="Article Image"
                class="w-full h-auto rounded-xl my-6"
            />

            <div class="article-content">
                {activeTab === "overview" && (
    <>
        <!-- Gallery Section -->
        <div class="article-content">
            <div class="mt-10 mb-10 px-6 relative overflow-visible">
                {/* Left arrow */}
                {entry.data.galleryImages.length > 3 && (
                    <button
                        type="button"
                        class="hidden sm:block absolute -left-10 top-16 -translate-y-1/2 z-10 p-2 sm:p-4 bg-white/80 hover:bg-white rounded-full shadow"
                        onclick="scrollGallery(-1)"
                    >
                        ◀
                    </button>
                )}

                <div
                    id="gallery"
                    class={`scroll-smooth overflow-x-auto ${
                        entry.data.galleryImages.length > 2
                            ? ""
                            : "overflow-x-hidden"
                    }`}
                    style="scrollbar-width: thin"
                >
                    <div
                        class={`flex gap-2 ${
                            entry.data.galleryImages.length <= 3
                                ? "justify-center"
                                : "pl-2 sm:pl-4 lg:pl-[calc(50%-160px)]"
                        }`}
                    >
                        {entry.data.galleryImages.map((img) => (
                            <img
                                src={img}
                                alt="Gallery Image"
                                class="w-64 sm:w-72 md:w-80 h-25 rounded shadow-md object-cover flex-shrink-0"
                                loading="lazy"
                            />
                        ))}
                    </div>
                </div>

                {/* Right arrow */}
                {entry.data.galleryImages.length > 3 && (
                    <button
                        type="button"
                        class="hidden sm:block absolute -right-10 top-16 -translate-y-1/2 z-10 p-2 sm:p-4 bg-white/80 hover:bg-white rounded-full shadow"
                        onclick="scrollGallery(1)"
                    >
                        ▶
                    </button>
                )}
            </div>
        </div>

        <!-- Regular Videos Section -->
        {entry.data.videos?.length > 0 && (
            <section class="mt-10 mb-10">
                <div class="flex flex-wrap justify-center gap-6 mx-auto max-w-screen-lg">
                    {entry.data.videos.map((video) => (
                        <div class="w-[50%] max-w-[450px]">
                            <video
                                controls
                                controlslist="nodownload"
                                style="max-width: 500px; width: 100%;"
                                class="aspect-video bg-black rounded shadow-md mb-4"
                            >
                                <source src={video} type="video/mp4" />
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    ))}
                </div>
            </section>
        )}
    </>
)}


            <!-- === Tabs Navigation Section === -->
            <nav class="mb-8 flex space-x-4 border-b-2 border-gray-300">
                <a
                    href={`/projects/${slug}?tab=overview`}
                    class={`pb-2 border-b-4 uppercase transition ${
                        activeTab === "overview"
                            ? "border-red-500 font-bold text-red-600"
                            : "border-transparent text-gray-700 font-semibold hover:border-red-500"
                    }`}
                    aria-current={activeTab === "overview" ? "page" : undefined}
                >
                    Overview
                </a>
                {
                    hasUpdates && (
                        <a
                            href={`/projects/${slug}?tab=updates`}
                            class={`pb-2 border-b-4 uppercase transition ${
                                activeTab === "updates"
                                    ? "border-red-500 font-bold text-red-600"
                                    : "border-transparent text-gray-700 font-semibold hover:border-red-500"
                            }`}
                            aria-current={
                                activeTab === "updates" ? "page" : undefined
                            }
                        >
                            Updates
                        </a>
                    )
                }
            </nav>

            {
                activeTab === "overview" ? (
                    <Content />
                ) : hasUpdates ? (
                    <>
                        <div set:html={updatesHTML} />

                        {entry.data.updateVideos?.length > 0 && (
                            <section
                                class={`update-videos mt-6 flex flex-wrap gap-6 max-w-screen-lg mx-auto ${
                                    entry.data.updateVideos.length === 1
                                        ? "justify-start"
                                        : "justify-center"
                                }`}
                            >
                                {" "}
                                {entry.data.updateVideos.map((video) => (
                                    <video
                                        controls
                                        controlslist="nodownload"
                                        style="max-width: 500px; width: 100%;"
                                        class="aspect-video bg-black rounded shadow-md mb-4"
                                        key={video}
                                    >
                                        <source src={video} type="video/mp4" />
                                        Your browser does not support the video
                                        tag.
                                    </video>
                                ))}
                            </section>
                        )}
                    </>
                ) : (
                    <p>No updates available.</p>
                )
            }
        </article>
    </div>
</MainLayout>

<style is:global>
    p {
        margin: 20px 0;
    }

    h2 {
        margin: 20px 0;
        font-size: 1.8rem;
    }

    .article-content ul {
        list-style: disc;
        padding-left: 40px;
    }

    .article-content ul li {
        margin: 10px 0;
    }

    /* Optional: Prevent horizontal scrolling on body */
    body {
        overflow-x: hidden;
    }
</style>
